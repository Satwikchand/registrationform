name: Build, Analyze, Deploy to Docker & Tomcat

on:
  push:
    branches: [ main ]

env:
  REPO: yannamsiva/registrationform
  NEXUS_URL: http://52.15.113.175:8081
  NEXUS_RELEASE_REPO: maven-releases
  NEXUS_SNAPSHOT_REPO: maven-snapshots
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Code Quality - SonarQube
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.login="${{ secrets.SONAR_TOKEN }}" \
            -Dsonar.host.url="https://sonarcloud.io"
            # Add these if using SonarCloud:
            # -Dsonar.organization=your-sonarcloud-org \
            # -Dsonar.projectKey=your-project-key
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Build Artifact
        run: mvn clean package

      - name: Determine Project Version
        id: version
        shell: bash
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Upload to Nexus
        shell: bash  # ← Critical!
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO_NAME="${{ env.NEXUS_RELEASE_REPO }}"
          if [[ "$VERSION" == *-SNAPSHOT ]]; then
            REPO_NAME="${{ env.NEXUS_SNAPSHOT_REPO }}"
          fi

          cat > settings.xml <<EOF
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                              http://maven.apache.org/xsd/settings-1.0.0.xsd">
  <servers>
    <server>
      <id>${{ env.NEXUS_SNAPSHOT_REPO }}</id>
      <username>${NEXUS_USER}</username>
      <password>${NEXUS_PASS}</password>
    </server>
    <server>
      <id>${{ env.NEXUS_RELEASE_REPO }}</id>
      <username>${NEXUS_USER}</username>
      <password>${NEXUS_PASS}</password>
    </server>
  </servers>
</settings>
EOF

          mvn deploy -s settings.xml

      - name: Get Latest Artifact from Nexus
        shell: bash  # ← Critical!
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO_ID="${{ env.NEXUS_SNAPSHOT_REPO }}"
          if [[ "$VERSION" != *-SNAPSHOT ]]; then
            REPO_ID="${{ env.NEXUS_RELEASE_REPO }}"
          fi

          if [[ "$VERSION" == *-SNAPSHOT ]]; then
            METADATA=$(curl -s -u "${NEXUS_USER}:${NEXUS_PASS}" \
              "${{ env.NEXUS_URL }}/repository/${REPO_ID}/com/aja/first-servlet-app/maven-metadata.xml")
            if [[ -z "$METADATA" ]]; then
              echo "ERROR: Failed to fetch maven-metadata.xml"
              exit 1
            fi
            VERSION=$(echo "$METADATA" | grep -oP '<version>\K[^<]*' | tail -n1)
            if [[ -z "$VERSION" ]]; then
              echo "ERROR: No version found in metadata"
              exit 1
            fi
          fi

          echo "Downloading version: $VERSION"
          curl -u "${NEXUS_USER}:${NEXUS_PASS}" -fSL \
            -o app.war \
            "${{ env.NEXUS_URL }}/repository/${REPO_ID}/com/aja/first-servlet-app/${VERSION}/first-servlet-app-${VERSION}.war"

      - name: Build Docker Image
        run: |
          cat > Dockerfile <<EOF
FROM tomcat:9-jre11
COPY app.war /usr/local/tomcat/webapps/ROOT.war
EOF
          docker build -t ${{ env.REPO }}:latest .

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_PASSW }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Push to Docker Hub
        run: docker push ${{ env.REPO }}:latest

      - name: Deploy to Local Tomcat Container (on runner)
        run: |
          docker stop tomcat-app || true
          docker rm tomcat-app || true
          docker run -d --name tomcat-app -p 9090:8080 ${{ env.REPO }}:latest
